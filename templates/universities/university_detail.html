{% extends 'base.html' %} {% load static %} {% load humanize %} {% block title %}{{ university.full_name }}{% endblock %} {% block content %}
<div class="container my-4">
  <!-- University Header -->
  <div class="d-flex justify-content-between align-items-center my-4">

    {# Back #}
    <a href="{{ back_url }}"
       class="btn btn-outline-secondary rounded-pill">
        <i class="fas fa-arrow-left me-2"></i> Ortga
    </a>
  
    {# Share #}
    <button type="button"
            id="shareBtn"
            class="btn btn-outline-primary rounded-pill"
            data-share-url="{{ share_url }}">
        <i class="fas fa-share-alt me-2"></i> Ulashish
    </button>
  
  </div>
  <div class="card border-0 mb-4">
    <div class="card-body p-4">
      <div class="d-flex align-items-center mb-3">
        <div class="me-3">
          <div class="bg-white rounded p-2" style="width: 64px; height: 64px; display: flex; align-items: center; justify-content: center">
            {% if university.logo %}
            <img src="{{ university.logo.url }}" alt="{{ university.full_name }}" class="img-fluid" />
            {% else %}
            <i class="fas fa-university fa-2x text-primary"></i>
            {% endif %}
          </div>
        </div>
        <div>
          <h1 class="h4 mb-1 fw-bold">{{ university.full_name }}</h1>
          <div class="d-flex align-items-center flex-wrap">
            <div class="small text-muted">{{ university.location.name|default:"? viloyat" }}</div>
            <div class="small text-muted">&nbsp;• {% firstof university.institution_category.name "" %}</div>
            <!-- {% if university.has_grant %}
                        <div class="ms-2">
                            <span class="badge bg-success">To'ldirilgan ma'lumot</span>
                        </div>
                        {% endif %} -->
          </div>
        </div>
      </div>

      <!-- University Key Info -->
      <div class="row g-3 mt-2">
        <div class="col-md-4">
          <div class="d-flex flex-column">
            <div class="text-muted me-2 small">
              <i class="far fa-calendar-alt me-1"></i>
              Qabul muddati
            </div>
            <div class="small fw-medium ms-2 mt-2">{{ admission_period|default:"Ma'lumot mavjud emas" }}</div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="d-flex flex-column">
            <div class="text-muted me-2 small">
              <i class="fas fa-dollar-sign me-1"></i>
              Kontrakt to'lovi
            </div>
            <div class="small fw-medium ms-2 mt-2">{{ tuition_fee_range }}</div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="d-flex flex-column">
            <div class="text-muted me-2 small">
              <i class="fas fa-university me-1"></i>
              OTM litsenziyasi
            </div>
            <div class="small fw-medium ms-2 mt-2">
              {% if university.license_file %}
              <a href="{{ university.license_file.url }}" target="_blank" class="text-decoration-none">
                <i class="fas fa-file-pdf me-1"></i>
                Yuklash
              </a>
              {% else %}
              <span class="text-muted">Ma'lumot mavjud emas</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="nav-sentinel"></div>

<!-- Navigation Tabs -->
<div class="container-fluid position-sticky top-0" style="z-index: 1000" id="universityTabs">
  <div class="container">
    <ul class="nav nav-tabs w-100" id="universityTabs">
      <li class="nav-item">
        <a class="nav-link active" href="#about">OTM haqida</a>
      </li>
      {% if university.has_grant %}
      <li class="nav-item">
        <a class="nav-link" href="#grants">Grantlar</a>
      </li>
      {% endif %}
      <li class="nav-item">
        <a class="nav-link" href="#programs">Ta'lim yo'nalishlari</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#gal">Galereya</a>
      </li>
    </ul>
  </div>
</div>

<div class="container my-4">
  <!-- About Section -->
  <div class="row">
    <div class="col-lg-8">
      <section id="about">
        <div class="row">
          <div class="col-lg-12">
            <div class="card border-0 mb-4">
              <div class="card-header">
                <h2 class="h5">OTM haqida</h2>
              </div>
              <div class="card-body p-4">
                {% if university.description %}
                <div class="expandable" id="aboutText" data-limit="300">{{ university.description|safe }}</div>
                {% endif %}
              </div>

              <div class="expand-toggle d-flex bg-info-subtle justify-content-center align-items-center border-top py-2 cursor-pointer" data-target="#aboutText">
                Ko'proq ko'rsatish <i class="fas fa-chevron-down ms-3"></i>
              </div>
            </div>
          </div>
        </div>
      </section>
      {% if university.has_grant %}
      <section id="grants">
        <div class="row">
          <div class="col-lg-12">
            <div class="card border-0 mb-4" id="grants">
              <div class="card-header">
                <h2 class="h5">Grantlar</h2>
              </div>
              <div class="card-body p-4">
                {% if university.has_grant and university.about_grant %}
                <div class="expandable" id="grantText" data-limit="300">{{ university.about_grant|safe }}</div>
                {% endif %}
              </div>

              {# ← Wide toggle bar under the card -------------------------------- #}
              <div class="expand-toggle d-flex bg-info-subtle justify-content-center align-items-center border-top py-2 cursor-pointer" data-target="#grantText">
                Ko'proq ko'rsatish <i class="fas fa-chevron-down ms-3"></i>
              </div>
            </div>
          </div>
        </div>
      </section>
      {% endif %}
    </div>

    <div class="col-lg-4">
      <div class="col-12 position-sticky">
        <div class="card border-0 mb-4">
          <div class="card-header">
            <h2 class="h5">Aloqa</h2>
          </div>
          <div class="card-body p-4">
            <ul class="list-unstyled">
              {% if university.admission_phone %}
              <li class="mb-2">
                <a href="tel:{{ university.admission_phone }}" class="text-decoration-none">
                  <i class="fas fa-phone-alt text-primary me-2"></i>
                  {{ university.admission_phone }}
                </a>
              </li>
              {% endif %} {% if university.web_site %}
              <li class="mb-2">
                <a href="{{ university.web_site }}" target="_blank" class="text-decoration-none">
                  <i class="fas fa-globe text-primary me-2"></i>
                  {{ university.web_site }}
                </a>
              </li>
              {% endif %} {% if university.support_email %}
              <li class="mb-2">
                <a href="mailto:{{ university.support_email }}" class="text-decoration-none">
                  <i class="fas fa-envelope text-primary me-2"></i>
                  {{ university.support_email }}
                </a>
              </li>
              {% endif %} {% if university.address %}
              <li class="mb-3">
                <div class="d-flex">
                  <i class="fas fa-map-marker-alt text-primary me-2 mt-1"></i>
                  <div>{{ university.address }}</div>
                </div>
              </li>
              {% endif %}
            </ul>

            {% if university.latitude and university.longitude %}
            <div class="ratio ratio-4x3 mt-3">
              <iframe
                src="https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q={{ university.longitude }},{{ university.latitude }}"
                frameborder="0"
                style="border: 0"
                allowfullscreen></iframe>
            </div>
            {% endif %}

            <!-- Social Media -->
            {% if university.instagram_username or university.telegram_username or university.facebook_username %}
            <div class="d-flex mt-3">
              {% if university.telegram_username %}
              <a
                href="{{ university.telegram_username }}"
                target="_blank"
                class="btn btn-sm btn-outline-primary rounded-circle me-2"
                style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center">
                <i class="fab fa-telegram-plane"></i>
              </a>
              {% endif %} {% if university.facebook_username %}
              <a
                href="{{ university.facebook_username }}"
                target="_blank"
                class="btn btn-sm btn-outline-primary rounded-circle me-2"
                style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center">
                <i class="fab fa-facebook-f"></i>
              </a>
              {% endif %} {% if university.instagram_username %}
              <a
                href="{{ university.instagram_username }}"
                target="_blank"
                class="btn btn-sm btn-outline-primary rounded-circle me-2"
                style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center">
                <i class="fab fa-instagram"></i>
              </a>
              {% endif %} {% if university.youtube_username %}
              <a
                href="{{ university.youtube_username }}"
                target="_blank"
                class="btn btn-sm btn-outline-primary rounded-circle me-2"
                style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center">
                <i class="fab fa-youtube"></i>
              </a>
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Programs Section -->
  <section id="programs" class="mb-5">
    <div class="card border-0 mb-4">
      <div class="card-header">
        <h2 class="h5">Ta'lim yo'nalishlari</h2>
      </div>

      <!-- Degree Tabs -->
      <ul class="nav nav-tabs px-4 pt-2 pb-0">
        <li class="nav-item">
          <a class="nav-link active" id="all-tab" data-bs-toggle="pill" href="#all-programs"> Barchasini ({{ directions|length }}) </a>
        </li>
        {% if degrees.bachelor %}
        <li class="nav-item">
          <a class="nav-link" id="bachelor-tab" data-bs-toggle="pill" href="#bachelor-programs"> Bakalavr ({{ degrees.bachelor|length }}) </a>
        </li>
        {% endif %} 
        {% if degrees.master %}
        <li class="nav-item">
          <a class="nav-link" id="master-tab" data-bs-toggle="pill" href="#master-programs"> Magistratura ({{ degrees.master|length }}) </a>
        </li>
        {% endif %}
        {% if degrees.other %}
        <li class="nav-item">
          <a class="nav-link" id="other-tab" data-bs-toggle="pill" href="#other-programs"> Boshqa ({{ degrees.other|length }}) </a>
        </li>
        {% endif %}
      </ul>
    </div>
    <div class="mb-4">
      <!-- Tab Content -->
      <div class="tab-content">
        <!-- All Programs Tab -->
        <div class="tab-pane fade show active" id="all-programs">
          {% if directions %} {% for direction in directions %}

          <div class="card border-0 mb-4">
            <div class="card-body p-4">
              {# ────────────────── Top row: logo + fee ────────────────── #}
              <div class="row align-items-center mb-3">
                <div class="col-12 col-lg-4 d-flex align-items-center">
                  <div class="bg-white rounded p-2 me-3" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center">
                    <img src="{{ university.logo.url|default:'#' }}" alt="{{ university.full_name }}" class="img-fluid" />
                  </div>
                  <div>
                    <h3 class="h6 fw-bold mb-1">{{ direction.direction_name }}</h3>
                    <p class="mb-0 small">{{ university.full_name }}</p>
                    {% if direction.application_deadline %}
                    <div class="small text-danger">Qabul tugaydi: {{ direction.application_deadline|date:"d F Y" }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="col-12 col-lg-8 text-end">
                  <div class="small mb-1 text-muted"><i class="fas fa-coins me-1"></i> Kontrakt to'lovi:</div>
                  {% with fee=direction.tuition_fees.first %}
                  <p class="fw-bold text-primary h5 mb-0">{% if fee %}{{ fee.local_tuition_fee|intcomma }} so'mdan boshlab {% else %}Ma'lumot mavjud emas{% endif %}</p>
                  {% endwith %} {% if direction.has_stipend %}
                  <div class="small text-success mt-1"><i class="fas fa-check-circle me-1"></i> Stipendiya mavjud</div>
                  {% endif %}
                </div>
              </div>

              {# ─────────────────── Info blocks + action button ─────────────────── #}
              <div class="row g-3 align-items-start">
                {# ── Daraja ── #}
                <div class="col-md-4">
                  <div class="small text-muted mb-1"><i class="fas fa-language me-1"></i> Daraja</div>
                  <div class="d-flex flex-wrap">
                    {% for degree in direction.degrees.all %}
                    <span class="badge bg-light text-dark me-1 mb-1">{{ degree.name }}</span>
                    {% empty %}
                    <span class="badge bg-light text-dark mb-1">Ma'lumot mavjud emas</span>
                    {% endfor %}
                  </div>
                </div>

                {# ── Taʼlim tili ── #}
                <div class="col-md-4">
                  <div class="small text-muted mb-1"><i class="fas fa-language me-1"></i> Ta'lim tili</div>
                  <div class="d-flex flex-wrap">
                    {% for language in direction.education_languages.all %}
                    <span class="badge bg-light text-dark me-1 mb-1">{{ language.name }}</span>
                    {% empty %}
                    <span class="badge bg-light text-dark mb-1">Ma'lumot mavjud emas</span>
                    {% endfor %}
                  </div>
                </div>

                {# ── Taʼlim shakli ── #}
                <div class="col-md-4">
                  <div class="small text-muted mb-1"><i class="fas fa-book-reader me-1"></i> Ta'lim shakli</div>
                  <div class="d-flex flex-wrap">
                    {% for type in direction.education_types.all %}
                    <span class="badge bg-light text-dark me-1 mb-1">{{ type.name }}</span>
                    {% empty %}
                    <span class="badge bg-light text-dark mb-1">Ma'lumot mavjud emas</span>
                    {% endfor %}
                  </div>
                </div>

                {# ── Talablar ── #}
                <div class="col-md-4">
                  <div class="small text-muted mb-1"><i class="fas fa-clipboard-list me-1"></i> Talablar</div>
                  <p class="small mb-0">{{ direction.requirement|default:"Ma'lumot mavjud emas" }}</p>
                </div>

                {# ── Action button, always last ── #}
                <div class="col-md-auto ms-auto d-flex align-items-start">
                  <a href="{% url 'universities:direction_detail' direction.direction_slug %}" class="btn btn-primary mt-2 mt-md-0"> Batafsil <i class="fas fa-arrow-right ms-1"></i></a>
                </div>
              </div>
            </div>
          </div>

          {% endfor %} {% else %}
          <div class="alert alert-info">Ma'lumot mavjud emas.</div>
          {% endif %}
        </div>

        <!-- Degree-specific tabs rendered dynamically -->
        {% for degree_type, degree_directions in degrees.items %} {% if degree_type != 'other' and degree_directions %}
        <div class="tab-pane fade" id="{{ degree_type }}-programs">
          {% for direction in degree_directions %}
          <div class="card border-0 mb-4">
            <div class="card-body p-4">
              {# ────────────────── Top row: logo + fee ────────────────── #}
              <div class="row align-items-center mb-3">
                <div class="col-12 col-lg-4 d-flex align-items-center">
                  <div class="bg-white rounded p-2 me-3" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center">
                    <img src="{{ university.logo.url|default:'#' }}" alt="{{ university.full_name }}" class="img-fluid" />
                  </div>
                  <div>
                    <h3 class="h6 fw-bold mb-1">{{ direction.direction_name }}</h3>
                    <p class="mb-0 small">{{ university.full_name }}</p>
                    {% if direction.application_deadline %}
                    <div class="small text-danger">Qabul tugaydi: {{ direction.application_deadline|date:"d F Y" }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="col-12 col-lg-8 text-end">
                  <div class="small mb-1 text-muted"><i class="fas fa-coins me-1"></i> Kontrakt to'lovi:</div>
                  {% with fee=direction.tuition_fees.first %}
                  <p class="fw-bold text-primary h5 mb-0">{% if fee %}{{ fee.local_tuition_fee|intcomma }} so'mdan boshlab {% else %}Ma'lumot mavjud emas{% endif %}</p>
                  {% endwith %} {% if direction.has_stipend %}
                  <div class="small text-success mt-1"><i class="fas fa-check-circle me-1"></i> Stipendiya mavjud</div>
                  {% endif %}
                </div>
              </div>

              {# ─────────────────── Info blocks + action button ─────────────────── #}
              <div class="row g-3 align-items-start">
                {# ── Daraja ── #}
                <div class="col-md-4">
                  <div class="small text-muted mb-1"><i class="fas fa-language me-1"></i> Daraja</div>
                  <div class="d-flex flex-wrap">
                    {% for degree in direction.degrees.all %}
                    <span class="badge bg-light text-dark me-1 mb-1">{{ degree.name }}</span>
                    {% empty %}
                    <span class="badge bg-light text-dark mb-1">Ma'lumot mavjud emas</span>
                    {% endfor %}
                  </div>
                </div>

                {# ── Taʼlim tili ── #}
                <div class="col-md-4">
                  <div class="small text-muted mb-1"><i class="fas fa-language me-1"></i> Ta'lim tili</div>
                  <div class="d-flex flex-wrap">
                    {% for language in direction.education_languages.all %}
                    <span class="badge bg-light text-dark me-1 mb-1">{{ language.name }}</span>
                    {% empty %}
                    <span class="badge bg-light text-dark mb-1">Ma'lumot mavjud emas</span>
                    {% endfor %}
                  </div>
                </div>

                {# ── Taʼlim shakli ── #}
                <div class="col-md-4">
                  <div class="small text-muted mb-1"><i class="fas fa-book-reader me-1"></i> Ta'lim shakli</div>
                  <div class="d-flex flex-wrap">
                    {% for type in direction.education_types.all %}
                    <span class="badge bg-light text-dark me-1 mb-1">{{ type.name }}</span>
                    {% empty %}
                    <span class="badge bg-light text-dark mb-1">Ma'lumot mavjud emas</span>
                    {% endfor %}
                  </div>
                </div>

                {# ── Talablar ── #}
                <div class="col-md-4">
                  <div class="small text-muted mb-1"><i class="fas fa-clipboard-list me-1"></i> Talablar</div>
                  <p class="small mb-0">{{ direction.requirement|default:"Ma'lumot mavjud emas" }}</p>
                </div>

                {# ── Action button, always last ── #}
                <div class="col-md-auto ms-auto d-flex align-items-start">
                  <a href="{% url 'universities:direction_detail' direction.direction_slug %}" class="btn btn-primary mt-2 mt-md-0"> Batafsil <i class="fas fa-arrow-right ms-1"></i></a>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %} {% endfor %}

        <!-- Other Programs Tab -->
        {% if degrees.other %}
        <div class="tab-pane fade" id="other-programs">
          {% for direction in degrees.other %}
          <div class="card border-0 mb-4">
            <div class="card-body p-4">
              {# ────────────────── Top row: logo + fee ────────────────── #}
              <div class="row align-items-center mb-3">
                <div class="col-12 col-lg-4 d-flex align-items-center">
                  <div class="bg-white rounded p-2 me-3" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center">
                    <img src="{{ university.logo.url|default:'#' }}" alt="{{ university.full_name }}" class="img-fluid" />
                  </div>
                  <div>
                    <h3 class="h6 fw-bold mb-1">{{ direction.direction_name }}</h3>
                    <p class="mb-0 small">{{ university.full_name }}</p>
                    {% if direction.application_deadline %}
                    <div class="small text-danger">Qabul tugaydi: {{ direction.application_deadline|date:"d F Y" }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="col-12 col-lg-8 text-end">
                  <div class="small mb-1 text-muted"><i class="fas fa-coins me-1"></i> Kontrakt to'lovi:</div>
                  {% with fee=direction.tuition_fees.first %}
                  <p class="fw-bold text-primary h5 mb-0">{% if fee %}{{ fee.local_tuition_fee|intcomma }} so'mdan boshlab {% else %}Ma'lumot mavjud emas{% endif %}</p>
                  {% endwith %} {% if direction.has_stipend %}
                  <div class="small text-success mt-1"><i class="fas fa-check-circle me-1"></i> Stipendiya mavjud</div>
                  {% endif %}
                </div>
              </div>

              {# ─────────────────── Info blocks + action button ─────────────────── #}
              <div class="row g-3 align-items-start">
                {# ── Daraja ── #}
                <div class="col-md-4">
                  <div class="small text-muted mb-1"><i class="fas fa-language me-1"></i> Daraja</div>
                  <div class="d-flex flex-wrap">
                    {% for degree in direction.degrees.all %}
                    <span class="badge bg-light text-dark me-1 mb-1">{{ degree.name }}</span>
                    {% empty %}
                    <span class="badge bg-light text-dark mb-1">Ma'lumot mavjud emas</span>
                    {% endfor %}
                  </div>
                </div>

                {# ── Taʼlim tili ── #}
                <div class="col-md-4">
                  <div class="small text-muted mb-1"><i class="fas fa-language me-1"></i> Ta'lim tili</div>
                  <div class="d-flex flex-wrap">
                    {% for language in direction.education_languages.all %}
                    <span class="badge bg-light text-dark me-1 mb-1">{{ language.name }}</span>
                    {% empty %}
                    <span class="badge bg-light text-dark mb-1">Ma'lumot mavjud emas</span>
                    {% endfor %}
                  </div>
                </div>

                {# ── Taʼlim shakli ── #}
                <div class="col-md-4">
                  <div class="small text-muted mb-1"><i class="fas fa-book-reader me-1"></i> Ta'lim shakli</div>
                  <div class="d-flex flex-wrap">
                    {% for type in direction.education_types.all %}
                    <span class="badge bg-light text-dark me-1 mb-1">{{ type.name }}</span>
                    {% empty %}
                    <span class="badge bg-light text-dark mb-1">Ma'lumot mavjud emas</span>
                    {% endfor %}
                  </div>
                </div>

                {# ── Talablar ── #}
                <div class="col-md-4">
                  <div class="small text-muted mb-1"><i class="fas fa-clipboard-list me-1"></i> Talablar</div>
                  <p class="small mb-0">{{ direction.requirement|default:"Ma'lumot mavjud emas" }}</p>
                </div>

                {# ── Action button, always last ── #}
                <div class="col-md-auto ms-auto d-flex align-items-start">
                  <a href="{% url 'universities:direction_detail' direction.direction_slug %}" class="btn btn-primary mt-2 mt-md-0"> Batafsil <i class="fas fa-arrow-right ms-1"></i></a>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- Gallery Section -->
  <section id="gal" class="mb-5">
    <div class="card border-0 mb-4">
      <div class="card-header">
        <h2 class="h5">Galereya</h2>
      </div>
      <div class="card-body p-4">
        {% if university.gallery_items.exists %}
        <div class="row g-4">
          {% for gallery_item in university.gallery_items.all %}
          <div class="col-md-4 mb-4">
            <div class="card border-0 h-100">
              {% if gallery_item.image %}
              <a href="{{ gallery_item.image.url }}" data-fancybox="gallery" class="d-block gallery-item">
                <img src="{{ gallery_item.image.url }}" class="img-fluid rounded" alt="Gallery image" style="object-fit: cover; width: 100%; height: 220px;" />
              </a>
              {% elif gallery_item.link %}
                {% if 'youtube.com/watch' in gallery_item.link %}
                  {% with youtube_id=gallery_item.link|cut:"https://www.youtube.com/watch?v="|cut:"http://www.youtube.com/watch?v=" %}
                    {% with clean_id=youtube_id|slice:":11" %}
                    <a href="https://www.youtube.com/embed/{{ clean_id }}" data-fancybox="gallery" class="d-block gallery-item">
                      <div class="position-relative">
                        <img src="https://img.youtube.com/vi/{{ clean_id }}/hqdefault.jpg" class="img-fluid rounded" alt="YouTube thumbnail" style="object-fit: cover; width: 100%; height: 220px;" />
                        <div class="position-absolute top-50 start-50 translate-middle text-danger">
                          <i class="fab fa-youtube fa-3x"></i>
                        </div>
                      </div>
                    </a>
                    {% endwith %}
                  {% endwith %}
                {% elif 'youtu.be' in gallery_item.link %}
                  {% with youtube_id=gallery_item.link|cut:"https://youtu.be/"|cut:"http://youtu.be/" %}
                    {% with clean_id=youtube_id|slice:":11" %}
                    <a href="https://www.youtube.com/embed/{{ clean_id }}" data-fancybox="gallery" class="d-block gallery-item">
                      <div class="position-relative">
                        <img src="https://img.youtube.com/vi/{{ clean_id }}/hqdefault.jpg" class="img-fluid rounded" alt="YouTube thumbnail" style="object-fit: cover; width: 100%; height: 220px;" />
                        <div class="position-absolute top-50 start-50 translate-middle text-danger">
                          <i class="fab fa-youtube fa-3x"></i>
                        </div>
                      </div>
                    </a>
                    {% endwith %}
                  {% endwith %}
                {% elif 'youtube.com/embed' in gallery_item.link %}
                  {% with youtube_id=gallery_item.link|cut:"https://www.youtube.com/embed/"|cut:"http://www.youtube.com/embed/" %}
                    {% with clean_id=youtube_id|slice:":11" %}
                    <a href="https://www.youtube.com/embed/{{ clean_id }}" data-fancybox="gallery" class="d-block gallery-item">
                      <div class="position-relative">
                        <img src="https://img.youtube.com/vi/{{ clean_id }}/hqdefault.jpg" class="img-fluid rounded" alt="YouTube thumbnail" style="object-fit: cover; width: 100%; height: 220px;" />
                        <div class="position-absolute top-50 start-50 translate-middle text-danger">
                          <i class="fab fa-youtube fa-3x"></i>
                        </div>
                      </div>
                    </a>
                    {% endwith %}
                  {% endwith %}
                {% else %}
                  <div class="ratio ratio-16x9">
                    <iframe src="{{ gallery_item.link }}" title="Media content" allowfullscreen></iframe>
                  </div>
                {% endif %}
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info">
          Ma'lumot mavjud emas
        </div>
        {% endif %}
      </div>
    </div>
  </section>
</div>

{% block extra_js %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const LIMIT_DEFAULT = 300;

    /* ---------- prepare each expandable block ---------- */
    document.querySelectorAll(".expandable").forEach((block) => {
      if (block.dataset.expandReady === "1") return; // idempotent
      block.dataset.expandReady = "1";

      const fullHTML = block.innerHTML.trim();
      const textOnly = block.innerHTML.trim();
      const limit = parseInt(block.dataset.limit || LIMIT_DEFAULT, 10);

      /* Too short → nothing to do (hide external bar if any). */
      if (textOnly.length <= limit) {
        const ext = document.querySelector(`[data-target="#${block.id}"]`);
        if (ext) ext.style.display = "none";
        return;
      }

      /* ---------- create preview ---------- */
      const previewHTML = textOnly.slice(0, limit) + "&hellip;";
      block.innerHTML = previewHTML;
      block.classList.add("is-collapsed");

      /* ---------- find / create toggle button ---------- */
      let btn = document.querySelector(`[data-target="#${block.id}"]`);
      if (!btn) {
        // fallback small button
        btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-sm btn-outline-primary mt-2";
        btn.innerHTML = "Ko'proq ko'rsatish <i class='fas fa-chevron-down ms-3'></i>";
        block.after(btn);
      } else {
        btn.innerHTML = "Ko'proq ko'rsatish <i class='fas fa-chevron-down ms-3'></i>";
      }

      /* ---------- toggle behaviour ---------- */
      let expanded = false;

      btn.addEventListener("click", () => {
        expanded = !expanded;
        block.innerHTML = expanded ? fullHTML : previewHTML;
        block.classList.toggle("is-expanded", expanded);
        block.classList.toggle("is-collapsed", !expanded);
        btn.innerHTML = expanded ? "Kamroq ko'rsatish <i class='fas fa-chevron-up ms-3'></i>" : "Ko'proq ko'rsatish <i class='fas fa-chevron-down ms-3'></i>";
      });
    });

    // Grab elements
    const nav = document.getElementById("universityTabs");
    let sentinel = document.getElementById("nav-sentinel");

    // ➊  If the sentinel isn't in the markup, inject it on the fly
    if (!sentinel) {
      sentinel = document.createElement("div");
      sentinel.id = "nav-sentinel";
      nav.parentNode.insertBefore(sentinel, nav);
    }

    // ➋  Create the observer
    const observer = new IntersectionObserver(
      ([entry]) => {
        // When the sentinel scrolls *out* of view at the top,
        // the nav has just become sticky
        if (!entry.isIntersecting && entry.boundingClientRect.top < 0) {
          nav.classList.add("is-stuck"); // 👉 your "stuck" state
        } else {
          nav.classList.remove("is-stuck"); // 👉 normal flow again
        }
      },
      {
        root: null, // viewport
        threshold: 0, // fire as soon as even 1 px crosses
      }
    );

    observer.observe(sentinel);
  });
</script>
<script>
  $(document).ready(function () {
    // Fancybox for gallery
    $('[data-fancybox="gallery"]').fancybox({
      buttons: ["zoom", "slideShow", "fullScreen", "close"],
      loop: true,
      animationEffect: "fade",
      transitionEffect: "fade",
      protect: true,
      iframe: {
        preload: false,
        css: {
          width: '850px',
          height: '500px'
        }
      },
      beforeShow: function(instance, current) {
        // For YouTube links, ensure they're using embed format
        if (current.src && current.src.indexOf('youtube.com/embed') > -1) {
          // The URL is already in the correct format
        }
      }
    });

    // Smooth scrolling and active tab management

    // Update active tab on scroll
    $(window).scroll(function () {
      var currentPosition = $(this).scrollTop();
      $("section").each(function () {
        var top = $(this).offset().top - 100;
        var bottom = top + $(this).outerHeight();
        if (currentPosition >= top && currentPosition <= bottom) {
          var id = $(this).attr("id");
          $("#universityTabs a").removeClass("active");
          $('#universityTabs a[href="#' + id + '"]').addClass("active");
        }
      });
    });
  });
</script>
{% endblock %} {% endblock %}
